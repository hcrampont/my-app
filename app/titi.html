<html>
  <head>
    <title>hello titi</title>
    <link rel="stylesheet" href="https://raw.githubusercontent.com/hcrampont/my-app/master/app/test.css">
    <link rel="stylesheet" href="https://raw.githubusercontent.com/hcrampont/my-app/master/app/test2.css">
    <script type="text/javascript" src="https://raw.githubusercontent.com/hcrampont/my-app/master/app/toto.js"></script>
    <style>
      body {background-color: powderblue;}
    </style>
  </head>
  <body>
    <script>
      console.log('hello toto')
    </script>
    <script>
      window.onbeforeunload = function(e) {
        console.log('onbeforeunload');
        window.location.hash = '#start'
      };
    </script>
    <script>
      fetch('https://raw.githubusercontent.com/hcrampont/my-app/master/app/test.json')
        .then(response => response.json())
        .then(data => {
          console.log(data)
          var blob = new Blob([JSON.stringify(data)], { "type": 'application/json' });
          var url = window.URL || window.webkitURL;
          var blobUrl = url.createObjectURL(blob);
          console.log(blobUrl)
          fetch(blobUrl)
            .then(response => response.json())
            .then(data => {console.log(data)})
        })
    </script>
    <script>
      function stripScripts(s) {
        return new Promise((resolve, reject) => {
          var div = document.createElement('html');
          div.innerHTML = s;
          var scripts = div.getElementsByTagName('script');
          var i = scripts.length;
          var scriptsSrc = [];
          while (i--) {
            if (scripts[i].src) {
              scriptsSrc.push(fetch(scripts[i].src).then(response => response.text()).then(data => data))
            } else {
              scriptsSrc.push(scripts[i].innerHTML)
            }
            scripts[i].parentNode.removeChild(scripts[i])
          }
          Promise.all(scriptsSrc).then((values) => {
            var globalScript = document.createElement('script');
            globalScript.innerHTML = values.reverse().join('\n');
            div.getElementsByTagName('head')[0].appendChild(globalScript);
            resolve(div.innerHTML);
          });
        });
      }

      function stripStyles(s) {
        console.log(s)
        return new Promise((resolve, reject) => {
          var div = document.createElement('html');
          div.innerHTML = s;
          var styles = div.getElementsByTagName('link');
          var i = styles.length;
          var stylesSrc = [];
          while (i--) {
            stylesSrc.push(fetch(styles[i].href).then(response => response.text()).then(data => data))
            styles[i].parentNode.removeChild(styles[i])
          }
          Promise.all(stylesSrc).then((values) => {
            var styleTag = div.getElementsByTagName('style')[0];
            var globalStyles = [styleTag.innerHTML].concat(values).reverse();
            div.getElementsByTagName('style')[0].innerHTML = globalStyles.join('\n');
            resolve(div.innerHTML);
          });
        });
      }

      function navigate(url) {
        fetch(url)
          .then(response => response.text())
          .then(data => {
            var html;
            html = data
            stripScripts(data)
              .then(htmlScripts => {
                stripStyles(htmlScripts).then(htmlStyles => {
                  console.log(htmlStyles)
                  var blob = new Blob([htmlStyles], { "type": 'text/html' });
                  var url = window.URL || window.webkitURL;
                  var blobUrl = url.createObjectURL(blob);
                  console.log(blobUrl)
                  window.open(blobUrl, '_self')
                })
              })
          })
      }
    </script>
    <h1>hello titi</h1>
    <p>hello titi</p>
  </body>
</html>
